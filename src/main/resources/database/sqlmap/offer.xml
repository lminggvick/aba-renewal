<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD MAPPER 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abacorp.aba.model.Offer">

    <!-- Mapper -->
    <resultMap id="offer" type="Offer">
        <id property="id" column="id" />
        <result property="deposit" column="deposit" />
        <result property="monthlyPrice" column="monthly_price" />
        <result property="managementPrice" column="management_price" />
        <result property="completionYear" column="completion_year" />
        <result property="type" column="type" />
        <result property="dealType" column="deal_type" />
        <result property="heatingType" column="heating_type" />
        <result property="heatingMethodType" column="heating_method_type" />
        <result property="status" column="status" />
        <result property="updatedAt" column="updated_at" typeHandler="org.apache.ibatis.type.SqlTimestampTypeHandler" />
        <result property="description" column="description" />
        <association property="dealer" resultMap="dealer" />
        <association property="offerAddress" resultMap="offerAddress" />
        <association property="offerAddition" resultMap="offerAddition" />
    </resultMap>

    <resultMap id="offerAddress" type="OfferAddress">
        <id property="offerId" column="offer_id" />
        <result property="latitude" column="latitude" />
        <result property="longitude" column="longitude" />
        <result property="jibun" column="jibun" />
        <result property="road" column="road" />
        <result property="buildingName" column="building_name" />
        <result property="dong" column="dong" />
        <result property="ho" column="ho" />
        <result property="entrance" column="entrance" />
        <result property="door" column="door" />
        <result property="floor" column="floor" />
        <result property="nearLocation" column="near_location" />
        <result property="belongsTo" column="belongs_to" />
    </resultMap>

    <resultMap id="offerAddition" type="OfferAddition">
        <id property="offerId" column="offer_id" />
        <result property="term" column="term" />
        <result property="tenant" column="tenant" />
        <result property="optionCategory" column="option_category" />
        <result property="managementCategory" column="management_category" />
        <result property="hasElevator" column="has_elevator" />
        <result property="canParking" column="can_parking" />
        <result property="canPet" column="can_pet" />
    </resultMap>

    <resultMap id="dealer" type="User">
        <id property="userId" column="user_id" />
        <result property="phone" column="phone" />
        <result property="agentPhone" column="agent_phone" />
    </resultMap>

    <!-- Commons `sql` -->
    <sql id="offerJoin">
        LEFT JOIN users ON ofs.dealer = users.user_id
        LEFT JOIN offer_addresses AS addrs ON ofs.id = addrs.offer_id
        LEFT JOIN offer_additions AS adds ON ofs.id = adds.offer_id
    </sql>

    <sql id="latitudeQualify">(addrs.latitude BETWEEN #{west} AND #{east})</sql>
    <sql id="longitudeQualify">(addrs.latitude BETWEEN #{west} AND #{east})</sql>
    <sql id="filtersQuery">
        /**
            If filters ...
            refer property is `MapFilterDto.class`
        */
        <if test="offerTypes.length != 0">
            AND (
            <foreach collection="offerTypes" item="type" index="i">
                ofs.type = #{type} <if test="i != offerTypes.length - 1">OR</if>
            </foreach>
            )
        </if>
        <if test="dealTypes.length != 0">
            AND (
            <foreach collection="dealTypes" item="type" index="i">
                ofs.deal_type = #{type} <if test="i != dealTypes.length - 1">OR</if>
            </foreach>
            )
        </if>
        <if test="maxDeposit != 0">AND (ofs.deposit BETWEEN 0 AND #{maxDeposit})</if>
        <if test="maxMonthlyPrice != 0">AND (ofs.monthly_price BETWEEN 0 AND #{maxMonthlyPrice})</if>
        <if test="isParking">AND (adds.can_parking = TRUE)</if>
        <if test="isNotTenant">AND (adds.tenant LIKE '%ë¬´%')</if>
        <if test="hasElevator">AND (adds.has_elevator = TRUE)</if>
        <if test="isPet">AND (adds.can_pet = TRUE)</if>
        <if test="isCanTerm">AND (adds.term > 0)</if>
        <if test="floor != 0">AND (addrs.floor = #{floor})</if>
        <if test="completionYear != 0">AND (ofs.completion_year = #{completionYear})</if>
        <if test="options.length != 0">
            <foreach collection="options" item="option">
            AND (adds.option_category LIKE CONCAT('%',#{option},'%'))
            </foreach>
       </if>
    </sql>

    <select id="selectOfferById" resultMap="offer" parameterType="int">
        SELECT * FROM offers AS ofs <include refid="offerJoin" />
        WHERE ofs.id = #{id}
    </select>

    <select id="selectOffersByFilters" resultMap="offer" parameterType="MapFiltersDto">
        SELECT * FROM offers AS ofs <include refid="offerJoin" />
        WHERE <include refid="latitudeQualify" />
        AND   <include refid="longitudeQualify" />
        <include refid="filtersQuery" />
    </select>

    <select id="selectOffersByRegion" resultMap="offer" parameterType="MapFiltersDto">
        SELECT * FROM offers AS ofs <include refid="offerJoin" />
        WHERE belongs_to LIKE CONCAT('%', #{belongsTo}, '%')
        <include refid="filtersQuery" />
    </select>

    <select id="selectOffersByLatLng" resultMap="offer" parameterType="MapFiltersDto">
        SELECT * FROM offers AS ofs <include refid="offerJoin" />
        WHERE addrs.latitude = #{latitude} AND addrs.longitude = #{longitude}
        <include refid="filtersQuery" />
    </select>

    <select id="selectCountByBelongsAndFilters" resultType="int" parameterType="MapFiltersDto">
        SELECT count(*) FROM offers AS ofs <include refid="offerJoin" />
        WHERE addrs.belongs_to LIKE CONCAT('%', #{belongsTo}, '%')
        <include refid="filtersQuery" />
    </select>

    <select id="selectOffersByIdKey" resultMap="offerAddress" parameterType="string">
        SELECT * FROM offer_addresses AS addrs
        WHERE offer_id LIKE CONCAT('%', #{idKey}, '%');
    </select>

    <insert id="insertOffer" parameterType="offer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO offers (
            deposit, monthly_price, management_price, type, deal_type, heating_type, status, dealer,
            completion_year, description, created_at, updated_at
        ) VALUES (
            #{deposit}, #{monthlyPrice}, #{managementPrice}, #{type}, #{dealType}, #{heatingType}, 'ON', 'test',
            #{completionYear}, #{description}, current_timestamp, current_timestamp
        )
    </insert>

    <insert id="insertOfferAddress" parameterType="offerAddress">
        INSERT INTO offer_addresses
        VALUES (
            #{offerId}, #{latitude}, #{longitude}, #{buildingName}, #{jibun}, #{road}, #{dong}, #{ho}, #{entrance}, #{door},
            #{floor}, #{nearLocation}, #{belongsTo}
         )
    </insert>

    <insert id="insertOfferAddition" parameterType="offerAddition">
        INSERT INTO offer_additions
        VALUES (
            #{offerId}, #{term}, #{tenant}, #{optionCategory}, #{managementCategory}, #{hasElevator}, #{canParking}, #{canPet}
        )
    </insert>
</mapper>
